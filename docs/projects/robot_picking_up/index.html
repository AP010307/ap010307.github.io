<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Coin picking robot | Allen Pham</title>
<meta name="keywords" content="Altium, Assembly, Circuit Design, Python">
<meta name="description" content="üîó View on GitHub

     


Overview
I spearheaded a group of five people in an ELEC 291 project that utilises the EFM8LB1 and ATMega32P microcontrollers to create a robot that is able to pick up 20 coins.
Introduction
This project is the ultimatum of my ELEC 291 course, where my team was tasked with creating a robot that could pick up 20 coins. The robot was designed to be able to stay within a perimeter powered by AC signal while detecting and picking up coins using multipl solenoids.">
<meta name="author" content="Allen Pham">
<link rel="canonical" href="https://ap010307.github.io/portfolio/projects/robot_picking_up/">
<link crossorigin="anonymous" href="/portfolio/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css" integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF&#43;13Dyqob6ASlTrTye8=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://ap010307.github.io/portfolio/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://ap010307.github.io/portfolio/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://ap010307.github.io/portfolio/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://ap010307.github.io/portfolio/apple-touch-icon.png">
<link rel="mask-icon" href="https://ap010307.github.io/portfolio/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://ap010307.github.io/portfolio/projects/robot_picking_up/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="https://ap010307.github.io/portfolio/projects/robot_picking_up/">
  <meta property="og:site_name" content="Allen Pham">
  <meta property="og:title" content="Coin picking robot">
  <meta property="og:description" content="üîó View on GitHub Overview I spearheaded a group of five people in an ELEC 291 project that utilises the EFM8LB1 and ATMega32P microcontrollers to create a robot that is able to pick up 20 coins.
Introduction This project is the ultimatum of my ELEC 291 course, where my team was tasked with creating a robot that could pick up 20 coins. The robot was designed to be able to stay within a perimeter powered by AC signal while detecting and picking up coins using multipl solenoids.">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="projects">
    <meta property="article:tag" content="Altium">
    <meta property="article:tag" content="Assembly">
    <meta property="article:tag" content="Circuit Design">
    <meta property="article:tag" content="Python">
      <meta property="og:image" content="https://ap010307.github.io/portfolio/logo.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://ap010307.github.io/portfolio/logo.png">
<meta name="twitter:title" content="Coin picking robot">
<meta name="twitter:description" content="üîó View on GitHub

     


Overview
I spearheaded a group of five people in an ELEC 291 project that utilises the EFM8LB1 and ATMega32P microcontrollers to create a robot that is able to pick up 20 coins.
Introduction
This project is the ultimatum of my ELEC 291 course, where my team was tasked with creating a robot that could pick up 20 coins. The robot was designed to be able to stay within a perimeter powered by AC signal while detecting and picking up coins using multipl solenoids.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Projects",
      "item": "https://ap010307.github.io/portfolio/projects/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Coin picking robot",
      "item": "https://ap010307.github.io/portfolio/projects/robot_picking_up/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Coin picking robot",
  "name": "Coin picking robot",
  "description": "üîó View on GitHub Overview I spearheaded a group of five people in an ELEC 291 project that utilises the EFM8LB1 and ATMega32P microcontrollers to create a robot that is able to pick up 20 coins.\nIntroduction This project is the ultimatum of my ELEC 291 course, where my team was tasked with creating a robot that could pick up 20 coins. The robot was designed to be able to stay within a perimeter powered by AC signal while detecting and picking up coins using multipl solenoids.\n",
  "keywords": [
    "Altium", "Assembly", "Circuit Design", "Python"
  ],
  "articleBody": "üîó View on GitHub Overview I spearheaded a group of five people in an ELEC 291 project that utilises the EFM8LB1 and ATMega32P microcontrollers to create a robot that is able to pick up 20 coins.\nIntroduction This project is the ultimatum of my ELEC 291 course, where my team was tasked with creating a robot that could pick up 20 coins. The robot was designed to be able to stay within a perimeter powered by AC signal while detecting and picking up coins using multipl solenoids.\nObjective The goal of this project is to build, program, and test a robot, capable of detecting and pick up coins, both autonomously and manually:\nThe project must utilize two microcontrollers (one for the robot and one for the remote). The two microcontrollers must be from different families. The list of MCUs included in the project 2 kit is as below:\nEFM8LB12 (C8051Fxxx family) ATMega328P (AVR family) MSP430G2553 (MSP430 family) PIC32MX130 (PIC family) LPC824 (ARM Cortex-M0 family) Both the robot and controller must be battery operated (AA and 9V)\nMetal detection: using a 1mH conductor coil and other relevant electrical components to construct a Colpitts Oscillator, which will act as a metal detector. The robot must be able to detect all Canadian coins in circulation.\nCoin-picking mechanism consists of two micro servo motors and an electromagnet. The robot must be able to pick up all Canadian coins in circulation and deposit them in a container situated at the front of the robot.\nThe robot must be programmed in C\nPerimeter detection: In automatic mode, the robot must operate within a 1m x 0.5m perimeter. The perimeter consists of a long rectangular wire carrying an AC signal either from a function generator or a LM-555 timer circuit. The robot must be able to detect and stay within the perimeter at any given point throughout the automatic process.\nAutomatic mode: The robot must be able to autonomously pick up 20 coins scattered randomly within the perimeter, without having four wheels leaving said perimeter. Upon completion, the robot stopped for further commands.\nManual mode: The robot must be able to pick up coins using a remote control. The remote control must be able to control the robot‚Äôs movement and coin-picking mechanism. The remote control must also be able to stop the robot at any given point.\nRemote control: must include an LCD to display the signal ‚Äústrength‚Äù coming from the coin detector, as well as a speaker that beeps whenever a coin is detected. The pitch of the speaker must correspond to the strength of the signal coming from the metal detector. A joystick is included in the project 2 kit, although any other suitable control methods are also allowed.\nInvestigation Idea Generation Ideas were generated and tackled base on design specifications and objectives listed above. For this project, the keys areas to focus on were:\nSuccinct integration of two different micro controller families via the C. Discrete MOSFETs to drive motor logic. Metal and perimeter detector circuits and logic. Radio communication via the JDY-40 radio. Remote must have LCD display, speaker and joystick. Once project objectives were identified, our group investigated each aspect as a whole and attempted to come up with a solution. Progress was monitored through regular check-ins and testing to ensure succinct integration at the end.\nInvestigation Design Our group‚Äôs first objective was deciding which microcontroller unit to use. At the end, we settled with the ATMEGA328P for the controller, and the EFM8 (included in our project 1 kit) for the robot. This decision stemmed from our extensive experience with both MCUs from previous labs and projects, as well as sufficient documentation to both (1)(2). For the metal detector circuit, there are multiple designs available on the Project 2 lecture slides (3). Our team built and tested all the designs and eventually settled the Colpitts Oscillator with discrete CMOS inverter. This set up ensured the most stable frequency output when a coin was detected, as well as being ergonomic enough to be incorporated into the overall robot design. Data Collection: Dedicated procedures to test the metal and perimeter detector were carried out to ensure succinct operation.\nBy placing the robot at various position and distance relative to the perimeter, the ‚Äúambient‚Äù perimeter frequency of the perimeter detector was consistently found to be around 56600Hz. We set this as our reference value. The frequency picked up by the metal detector when different types of coins were detected varied. Each coin type had a ‚Äúsignature‚Äù range of frequency. We later take the average of each coin type‚Äôs frequency and their difference from the ambient metal detector frequency (i.e. when nothing is in the vicinity of the metal detector) as a base to drive our metal detector logic. Data Synthesis: The data found regarding the frequency generated by both the metal and perimeter detector under different conditions served as an important foundation for the robot logic. The accuracy of data collected were further verified using an oscilloscope and excel arithmetic. Via C, we hardcoded the baseline frequency for both detectors. These baseline values directly control the motor that moves the robot around, as well as the coin-picking mechanism (both the servo ‚Äúarm‚Äù and the electromagnet). Once sufficient data was achieved, it all came down to simple arithmetic and if-else statements in the C-language to drive the robot logic.\nAnalysis of result: Through troubleshooting and calibration, we mitigated errors due to hardware limitations and environmental factors with regards to both the metal and perimeter detector. Our analysis confirmed both apparatuses operating within acceptable error margins and frequency data used as baseline values to drive the robot logic resulted in accurate, consistent and predictable robot behavior.\nDesign Hardware The robot and remote controller‚Äôs hardware are as follows:\nRobot No. Components Quantity 1 EFM8LB12 1.0 2 LTV846 2.0 3 LM358P 1.0 4 LM7805 2.0 5 MCP1700 1.0 6 FQU8P10 5.0 7 FQU13N06LTU 6.0 8 1N4148 1.0 9 M8275-ND 3.0 10 QRD114 2.0 11 MBR150 2.0 12 Capacitor 10¬µF 2.0 13 Capacitor 1nF 1.0 14 Capacitor 10nF 1.0 15 Capacitor 100nF 2.0 16 Resistor 330‚Ñ¶ 2.0 17 Resistor 1K‚Ñ¶ 7.0 18 Resistor 4.7K‚Ñ¶ 1.0 19 Resistor 100K‚Ñ¶ 4.0 20 Resistor 330K‚Ñ¶ 2.0 Remote controller No. Components Quantity 1 ATMega328P 1 2 CEM-1203(42) 1 3 FT230XSR 1 4 FQU13N06LTU 1 5 JDY-40 1 6 MCP1700 6 7 1N4148 1 8 QYF-860 1 9 Resistor 2K‚Ñ¶ 1 10 Resistor 1K‚Ñ¶ 1 11 Push buttons 2 12 Capacitor 0.1¬µF 1 13 Capacitor 100¬µF 1 The robot system was composed of multiple functional components: the robot chassis motor drive, microcontroller, metal and perimeter detectors, wireless radio communication and coin-picking mechanism. Each subsystem was designed by applying principles of embedded systems, A/D design circuit design and power management.\nPower regulation:\nDesign approach: The robot uses 4x AA batteries (6V) to power the motors and optocouplers, and a 9V battery regulated to 5V by an LM7805 and an MCP1700 for 3.3V.\nLM7805: provides 5V for the EFM8 and sensors.\nMCP1700: provides 3.3V for JDY-40 and microcontroller\nMicrocontroller system:\nRobot MCU ‚Äì EFM8: 4 PWM digital outputs for motor control, UART + SET pins for JDY-40 communication, 1 digital input for metal detector, and 4 analog inputs for perimeter detectors Remote MCU ‚Äì ATMEGA328: 6 digital outputs for LCD, 2 analog inputs for joystick, 1 digital output for speaker, 3 UART pins for JDY-40 Motor driver: H-bridge and optocouplers 2 discrete H-bridges, each consists of N-MOS and P-MOS transistors driven by optocouplers (LTV-847), control 2 DC motors by isolation motor power circuitry from the logic-level control. Metal detector: A Colpitts Oscillator with discrete CMOS inverter built from discrete components. Powered at 5V The frequency shift when metal is in the vicinity is detected by the MCU Perimeter detectors: A peak detector circuit, whose signal is amplified using an Op-Amp. Two were put perpendicular to each other at the front of the robot chassis for all-direction sensitivity Output is fed to analog pins of the EFM8 for perimeter detection logic Radio communication: JDY-40 radio pair Uses RXD, TXD and SET pins for serial communication between robot and remote. Powered by 3.3 V and communicates at 9600 baud Joystick, speaker and LCD (remote): Joystick: 2-axis analog potentiometer-type joystick connected to 2 analog inputs LCD: standard 14-bit display driven by MCU digital outputs Speaker: generates PWM audio cues via a single digital output Coin-picking mechanism: Utilizes an electromagnet, servo motors and chassis-integrated basket to pick up metal coins. Standard Operating Procedure Our team began with a structured engineering approach to ensure each subsystem was reliably tested and validated before moving on to subsequent phases of the project. First, we focused on the hardware: we assembled the robot chassis (wheels, motors, coin picking assembly, electromagnet, inductor coils for metal and perimeter detector and basket), and tested the key components‚Äîsuch as the Colpitts oscillator and simple perimeter detector circuits, both microcontrollers (ATMEGA328 and EFM8), JDY-40 radios‚Äîto confirm they functioned correctly. By establishing a stable hardware baseline, we minimized the risk of falsely attributing errors during software development to hardware issues.\nRequirements and Constraints We gathered requirements by discussing baseline robot operations based on the outlined requirements, carefully examining the lecture slides and reviewing relevant best practices for designing and operating a multi-pronged system such as this project. From these activities, we identified the following needs and constraints:\nStreamlined controls during manual mode: the remote (both in terms of hardware and software) must be designed to allow for intuitive and ease of control during manual operations. Steps must be made to always allow for smooth and accurate controls with little interruptions, glitches or delay. Optimized robot logic during automatic operation: the robot must be able to perform multiple tasks simultaneously at any given point. This emphasizes the need for a clear logic flow that will allow for optimal performance and ease of debugging. Succinct integration between automatic and manual mode: The operator must be able to switch between automatic and manual mode at any given time. Once in automatic mode, the robot must strictly adhere to the base requirements of this project (i.e. stays withing the perimeter, automatically detects and picks up coin). In addition, after the 20 coins have been picked up during the automatic process, the robot should halt and awaits further instructions from the operator. Relevant Information Display: The remote should (at the bare minimum) display the signal strength based on which type of coins are detected. The signal strength must also be represented by an audio cue via a speaker. By systematically identifying and documenting these needs, we ensured our design choices directly addressed user requirements and practical constraints from the outset, helping guide all subsequent design and development efforts. Solution Generation Our team generated solution systematically and took into consideration various methods to address the project‚Äôs core requirements. We started by investigating different hardware and software configurations to deal with the robot‚Äôs various operational requirements.\nControls: We opted for a simple, 2-axis control via the provided joystick when it comes to the movement of the robot. The robot arm can be activated by pressing down on the joystick Toggling between manual and automatic mode can be done via a pushbutton. Radio communication between robot and remote: The ATMEGA328 microcontroller had several built-in ADC input pins, which, when connected to the joystick, can translate its movement into ADC signal and then to voltage. We then programmed the movement of the robot by figuring out the joystick‚Äôs ‚Äúdead zone‚Äù and finetuning it to fit with the H-bridge logic, which is then used to move the robot. Software Implementation: Our team decided to drive the robot‚Äôs logic by imbedding different parameters as presets. From the frequency picked up by the perimeter and metal detector, to the text command signals sent and received from the robot to the remote, we were able to systematically work out the robot‚Äôs core operation via simple while loops and if-else statements. This greatly enhanced the efficiency of our workflow, allowed for ease of debugging and optimized the robot‚Äôs performance and accuracy. Solution Evaluation After potential solutions were generated, we evaluated each of them based on accuracy, ease of implementation and how well each idea interacts with one and another in the context of this project. Our evaluation criteria included:\nHardware reliability: assuring an ergonomic, neat and efficient circuit design that minimizes errors and allows for easier modification and troubleshooting, as well as succinct integration with software. Software efficiency: ensuring an optimal and logical code flow that once again highlights the need for ease of troubleshooting and modification. Efficient and predictable robot operation. Key Findings: Although a simple control scheme and clear logic-based code fast-tracked the development of our design, we encountered multiple hiccups regarding to the communication between the robot and remote, which caused unpredictable robot movements, delays and crashes. We eventually narrowed down the cause of the issue: the radio communication received by the robot from the remote were somehow being offset. To be more specific:\nFor example, during manual operation, when the robot is commanded to move forward, the operator moves the joystick forward, which will send a series of signal to the robot, the continuous signal looks something like this: ‚Äú!FN!FN!‚Ä¶.‚Äù The software of the robot was supposed to only grab ‚ÄúFN‚Äù, which was the valid command for ‚Äúforward neutral‚Äù, but sometimes, it picked up ‚Äú!F‚Äù, which was a false command based on our existing logic. This happened consistently for other commands as well, causing the robot to behave unpredictably. We were able to fix this issue by hardcoding the invalid commands (i.e. ‚Äú!F‚Äù, etc.) as valid instructions. This fixed the issue, while maintaining the overall code efficiency and logic flow: Software Slave code: Servos control: Implemented in Timer5_ISR, creating PWM signals with a 20ms period Sensor integration: Metal detector: coins are detected via frequency shift Perimeter detectors: voltage threshold logic triggers a perimeter flag Movement control: Motor logic implemented via move_robot() function; encoded movement commands include: ‚ÄúFN‚Äù: Forward (2-wheels moving forward), ‚ÄúBN‚Äù: Backwards (2-wheels moving backward), ‚ÄúHL‚Äù / ‚ÄúHR‚Äù: Hard-left, Hard-right (1-wheel moving forward, other backward), ‚ÄúFL‚Äù / ‚ÄúFR‚Äù: Gradual-left, Gradual-right (Only one wheel moving forward), BL‚Äù / ‚ÄúBR‚Äù: Back-left, Back-right (Only one wheel moving backward) and ‚ÄúST‚Äù: Stop Coin-picking mechanism: Servos_magnet() executes a defined range of motion sequence to pick up coins upon detection Wireless communication: Slave-to-master transmits coin data types (‚Äú!DO‚Äù - Dollar, ‚Äú!TW‚Äù ‚Äì 2 Dollars, ‚Äú!NI‚Äù ‚Äì Nickel, etc.) ‚ÄúTO‚Äù ‚Äì toggles between manual and automatic modes ‚ÄúPU‚Äù - triggers the coin pick-up sequence Unknown commands are handled (see Key findings, above) Automatic mode logic: Moves forward by default If perimeter is detected, triggers perimeter_flag, then executes a range of motion moving backward then turning right (the degree of turn is randomized) If metal is detected, uses frequency difference baseline to: Detect presence of coin (triggers coinflag); Classify coin types (coin_tier); Broadcast coin classification to master (remote); Activate servos_magnet() to collect coin Coin collection is hardcoded to 20. After 20 pick-ups, the robot stops. Note that the robot has no means to detect a successful pick-up. It counts every activation of the coin-picking assembly as an attempt. Manual mode logic: In manual mode, commands are received wirelessly and processed directly ‚ÄúPU‚Äù initiates the pick-up sequence Directional and stop commands are passed to move_robot() Master Code: Core features: Joystick-based control: reads analog joystick input to send movement commands. Mode toggle: a pushbutton to toggle between automatic and manual mode by sending ‚Äú!TO‚Äù and waits for ‚Äú!TD‚Äù / ‚Äú!TF confirmation Pressing down on the joystick to send ‚Äú!PU‚Äù to activate the coin collection sequence JDY-40 communication: Sends commands with a ‚Äú!‚Äù header (e.g., ‚Äú!FN‚Äù, ‚Äú!ST‚Äù, ‚Äú!PU‚Äù, etc.) Receives coin types identifiers from the robot (‚ÄúDI‚Äù, ‚ÄúQU‚Äù, ‚ÄúNI‚Äù, ‚ÄúTW‚Äù, ‚ÄúDO‚Äù) and toggles ‚ÄúTF‚Äù from the robot Speaker feedback: Uses Timer0 interrupts to generates tones with different frequencies based on coin type: LCD feedback: Two-line LCD display: Current mode (‚ÄúToggle On/Off‚Äù) and coin strength Display and updates joystick command (e.g. Forward, etc.) Solution assessment The robot was tested over 20 independent trials across various coin placement within the perimeter Consistency of successful number of coins pick up per run remained at 18-19 out of 20 coins (¬± 1) List of performed tests and observations: Test Expected Outcome Observed Outcome Pass/Fail Coin detection (static and moving) Coin correctly identified and picked up Coin detection is 100% functional, but hardcoded movement after pickup only allowed for 80‚Äì90% success Pass (Partial) Boundary detection Robot reroutes away from the perimeter Correct response 100% of the time Pass Remote toggle and command response Mode toggles + joystick driving Works reliably with LCD feedback; minor inconsistency with auto/manual toggle Pass (Partial) Coin classification Correct sound + LCD All coin types correctly identified Pass Conclusion and Reflection This project was a great learning experience in hardware design, firmware development, and time management. Using two family of microcontrollers required a lot of planning, testing and attention to details as well as a lot of debugging. I learned the use of makefiles, code initialization and the importance of coding sparingly and efficiently. I also learned the importance of clear hardware design and wiring as it made the debugging process much easier. I also learned the importance of testing and validating each subsystem before moving on to the next phase of the project. This helped us to identify and fix issues early on, rather than waiting until the end of the project to find out that something was not working.\nI was also really proud of the team perserverance and dedication to the project. Despite having both technical difficulties when integrating the radio communication and some communication issues within the team especially at the end when we also had final exams, we were able to come together, push through till the final hours of the project and delivered an product that was worthy of pads on the back.\nAcknowledgements I want to thank my team members, Jackson Rockford, Matthew Yeun, Harry Nguyen and Adrian Chua for their hard work and dedication to the project. I also want to thank the ELEC 291 instructor, Jesus Calvino-Fraga for his guidance and support throughout the project.\n",
  "wordCount" : "3022",
  "inLanguage": "en",
  "image": "https://ap010307.github.io/portfolio/logo.png","datePublished": "0001-01-01T00:00:00Z",
  "dateModified": "0001-01-01T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Allen Pham"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://ap010307.github.io/portfolio/projects/robot_picking_up/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Allen Pham",
    "logo": {
      "@type": "ImageObject",
      "url": "https://ap010307.github.io/portfolio/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://ap010307.github.io/portfolio/" accesskey="h" title="Allen Pham (Alt + H)">Allen Pham</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://ap010307.github.io/portfolio/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://ap010307.github.io/portfolio/projects/" title="Projects">
                    <span>Projects</span>
                </a>
            </li>
            <li>
                <a href="https://ap010307.github.io/portfolio/electrical_engineering_resume__newest.pdf" title="Resume">
                    <span>Resume</span>
                </a>
            </li>
            <li>
                <a href="https://ap010307.github.io/portfolio/blogs/" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://ap010307.github.io/portfolio/">Home</a>&nbsp;¬ª&nbsp;<a href="https://ap010307.github.io/portfolio/projects/">Projects</a></div>
    <h1 class="post-title entry-hint-parent">
      Coin picking robot
    </h1>
    <div class="post-meta">15 min&nbsp;¬∑&nbsp;Allen Pham

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#overview" aria-label="Overview">Overview</a></li>
                <li>
                    <a href="#introduction" aria-label="Introduction">Introduction</a></li>
                <li>
                    <a href="#objective" aria-label="Objective">Objective</a></li>
                <li>
                    <a href="#investigation" aria-label="Investigation">Investigation</a><ul>
                        
                <li>
                    <a href="#idea-generation" aria-label="Idea Generation">Idea Generation</a></li>
                <li>
                    <a href="#investigation-design" aria-label="Investigation Design">Investigation Design</a></li>
                <li>
                    <a href="#data-collection" aria-label="Data Collection:">Data Collection:</a></li>
                <li>
                    <a href="#data-synthesis" aria-label="Data Synthesis:">Data Synthesis:</a></li>
                <li>
                    <a href="#analysis-of-result" aria-label="Analysis of result:">Analysis of result:</a></li></ul>
                </li>
                <li>
                    <a href="#design" aria-label="Design">Design</a><ul>
                        
                <li>
                    <a href="#hardware" aria-label="Hardware">Hardware</a><ul>
                        <ul>
                        
                <li>
                    <a href="#robot" aria-label="Robot">Robot</a></li>
                <li>
                    <a href="#remote-controller" aria-label="Remote controller">Remote controller</a></li></ul>
                    </ul>
                </li>
                <li>
                    <a href="#standard-operating-procedure" aria-label="Standard Operating Procedure">Standard Operating Procedure</a></li>
                <li>
                    <a href="#requirements-and-constraints" aria-label="Requirements and Constraints">Requirements and Constraints</a></li>
                <li>
                    <a href="#solution-generation" aria-label="Solution Generation">Solution Generation</a></li>
                <li>
                    <a href="#solution-evaluation" aria-label="Solution Evaluation">Solution Evaluation</a></li>
                <li>
                    <a href="#key-findings" aria-label="Key Findings:">Key Findings:</a></li>
                <li>
                    <a href="#software" aria-label="Software">Software</a></li></ul>
                </li>
                <li>
                    <a href="#solution-assessment" aria-label="Solution assessment">Solution assessment</a></li>
                <li>
                    <a href="#conclusion-and-reflection" aria-label="Conclusion and Reflection">Conclusion and Reflection</a></li>
                <li>
                    <a href="#acknowledgements" aria-label="Acknowledgements">Acknowledgements</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p><a href="https://github.com/AP010307/ELEC-291-Coin-Picking-Robot">üîó View on GitHub</a>
<figure>
    <img loading="lazy" src="top_view.jpg"
         alt="Robot and Remote"/> 
</figure>
</p>
<h1 id="overview">Overview<a hidden class="anchor" aria-hidden="true" href="#overview">#</a></h1>
<p>I spearheaded a group of five people in an ELEC 291 project that utilises the EFM8LB1 and ATMega32P microcontrollers to create a robot that is able to pick up 20 coins.</p>
<h1 id="introduction">Introduction<a hidden class="anchor" aria-hidden="true" href="#introduction">#</a></h1>
<p>This project is the ultimatum of my ELEC 291 course, where my team was tasked with creating a robot that could pick up 20 coins. The robot was designed to be able to stay within a perimeter powered by AC signal while detecting and picking up coins using multipl solenoids.</p>
<h1 id="objective">Objective<a hidden class="anchor" aria-hidden="true" href="#objective">#</a></h1>
<p>The goal of this project is to build, program, and test a robot, capable of detecting and pick up coins, both autonomously and manually:</p>
<ul>
<li>
<p>The project must utilize two microcontrollers (one for the robot and one for the remote). The two microcontrollers must be from different families. The list of MCUs included in the project 2 kit is as below:</p>
<ul>
<li><strong>EFM8LB12</strong> (C8051Fxxx family)</li>
<li><strong>ATMega328P</strong> (AVR family)</li>
<li><strong>MSP430G2553</strong> (MSP430 family)</li>
<li><strong>PIC32MX130</strong> (PIC family)</li>
<li><strong>LPC824</strong> (ARM Cortex-M0 family)</li>
</ul>
</li>
<li>
<p><strong>Both the robot and controller must be battery operated (AA and 9V)</strong></p>
</li>
<li>
<p><strong>Metal detection</strong>: using a 1mH conductor coil and other relevant electrical components to construct a Colpitts Oscillator, which will act as a metal detector. The robot must be able to detect all Canadian coins in circulation.</p>
</li>
<li>
<p>Coin-picking mechanism consists of two micro servo motors and an electromagnet. The robot must be able to pick up all Canadian coins in circulation and deposit them in a container situated at the front of the robot.</p>
</li>
<li>
<p><strong>The robot must be programmed in C</strong></p>
</li>
<li>
<p><strong>Perimeter detection</strong>: In automatic mode, the robot must operate within a 1m x 0.5m perimeter. The perimeter consists of a long rectangular wire carrying an AC signal either from a function generator or a LM-555 timer circuit. The robot must be able to detect and stay within the perimeter at any given point throughout the automatic process.</p>
</li>
<li>
<p><strong>Automatic mode</strong>: The robot must be able to autonomously pick up 20 coins scattered randomly within the perimeter, without having four wheels leaving said perimeter. Upon completion, the robot stopped for further commands.</p>
</li>
<li>
<p><strong>Manual mode</strong>: The robot must be able to pick up coins using a remote control. The remote control must be able to control the robot&rsquo;s movement and coin-picking mechanism. The remote control must also be able to stop the robot at any given point.</p>
</li>
<li>
<p><strong>Remote control</strong>: must include an LCD to display the signal ‚Äústrength‚Äù coming from the coin detector, as well as a speaker that beeps whenever a coin is detected. The pitch of the speaker must correspond to the strength of the signal coming from the metal detector. A joystick is included in the project 2 kit, although any other suitable control methods are also allowed.</p>
</li>
</ul>
<h1 id="investigation">Investigation<a hidden class="anchor" aria-hidden="true" href="#investigation">#</a></h1>
<h2 id="idea-generation">Idea Generation<a hidden class="anchor" aria-hidden="true" href="#idea-generation">#</a></h2>
<p>Ideas were generated and tackled base on design specifications and objectives listed above. For this project, the keys areas to focus on were:</p>
<ul>
<li>Succinct integration of two different micro controller families via the C.</li>
<li>Discrete MOSFETs to drive motor logic.</li>
<li>Metal and perimeter detector circuits and logic.</li>
<li>Radio communication via the JDY-40 radio.</li>
<li>Remote must have LCD display, speaker and joystick.</li>
</ul>
<p>Once project objectives were identified, our group investigated each aspect as a whole and attempted to come up with a solution. Progress was monitored through regular check-ins and testing to ensure succinct integration at the end.</p>
<h2 id="investigation-design">Investigation Design<a hidden class="anchor" aria-hidden="true" href="#investigation-design">#</a></h2>
<ul>
<li>Our group‚Äôs first objective was deciding which microcontroller unit to use. At the end, we settled with the ATMEGA328P for the controller, and the EFM8 (included in our project 1 kit) for the robot. This decision stemmed from our extensive experience with both MCUs from previous labs and projects, as well as sufficient documentation to both (1)(2).</li>
<li>For the metal detector circuit, there are multiple designs available on the Project 2 lecture slides (3). Our team built and tested all the designs and eventually settled the Colpitts Oscillator with discrete CMOS inverter. This set up ensured the most stable frequency output when a coin was detected, as well as being ergonomic enough to be incorporated into the overall robot design.</li>
</ul>
<h2 id="data-collection">Data Collection:<a hidden class="anchor" aria-hidden="true" href="#data-collection">#</a></h2>
<p>Dedicated procedures to test the metal and perimeter detector were carried out to ensure succinct operation.</p>
<ul>
<li>By placing the robot at various position and distance relative to the perimeter, the ‚Äúambient‚Äù perimeter frequency of the perimeter detector was consistently found to be around 56600Hz. We set this as our reference value. The frequency picked up by the metal detector when different types of coins were detected varied. Each coin type had a ‚Äúsignature‚Äù range of frequency. We later take the average of each coin type‚Äôs frequency and their difference from the ambient metal detector frequency (i.e. when nothing is in the vicinity of the metal detector) as a base to drive our metal detector logic.</li>
</ul>
<figure>
     <img loading="lazy" src="frequency.jpg"
          alt="Different and mean frequencies of each type of coin"/> 
 </figure>

<h2 id="data-synthesis">Data Synthesis:<a hidden class="anchor" aria-hidden="true" href="#data-synthesis">#</a></h2>
<p>The data found regarding the frequency generated by both the metal and perimeter detector under different conditions served as an important foundation for the robot logic. The accuracy of data collected were further verified using an oscilloscope and excel arithmetic. Via C, we hardcoded the baseline frequency for both detectors. These baseline values directly control the motor that moves the robot around, as well as the coin-picking mechanism (both the servo ‚Äúarm‚Äù and the electromagnet). Once sufficient data was achieved, it all came down to simple arithmetic and if-else statements in the C-language to drive the robot logic.</p>
<h2 id="analysis-of-result">Analysis of result:<a hidden class="anchor" aria-hidden="true" href="#analysis-of-result">#</a></h2>
<p>Through troubleshooting and calibration, we mitigated errors due to hardware limitations and environmental factors with regards to both the metal and perimeter detector. Our analysis confirmed both apparatuses operating within acceptable error margins and frequency data used as baseline values to drive the robot logic resulted in accurate, consistent and predictable robot behavior.</p>
<h1 id="design">Design<a hidden class="anchor" aria-hidden="true" href="#design">#</a></h1>
<h2 id="hardware">Hardware<a hidden class="anchor" aria-hidden="true" href="#hardware">#</a></h2>
<p>The robot and remote controller&rsquo;s hardware are as follows:</p>
<h4 id="robot">Robot<a hidden class="anchor" aria-hidden="true" href="#robot">#</a></h4>
<figure>
    <img loading="lazy" src="just_robot.jpg"
         alt="Robot"/> 
</figure>

<table>
  <thead>
      <tr>
          <th>No.</th>
          <th>Components</th>
          <th>Quantity</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>1</td>
          <td>EFM8LB12</td>
          <td>1.0</td>
      </tr>
      <tr>
          <td>2</td>
          <td>LTV846</td>
          <td>2.0</td>
      </tr>
      <tr>
          <td>3</td>
          <td>LM358P</td>
          <td>1.0</td>
      </tr>
      <tr>
          <td>4</td>
          <td>LM7805</td>
          <td>2.0</td>
      </tr>
      <tr>
          <td>5</td>
          <td>MCP1700</td>
          <td>1.0</td>
      </tr>
      <tr>
          <td>6</td>
          <td>FQU8P10</td>
          <td>5.0</td>
      </tr>
      <tr>
          <td>7</td>
          <td>FQU13N06LTU</td>
          <td>6.0</td>
      </tr>
      <tr>
          <td>8</td>
          <td>1N4148</td>
          <td>1.0</td>
      </tr>
      <tr>
          <td>9</td>
          <td>M8275-ND</td>
          <td>3.0</td>
      </tr>
      <tr>
          <td>10</td>
          <td>QRD114</td>
          <td>2.0</td>
      </tr>
      <tr>
          <td>11</td>
          <td>MBR150</td>
          <td>2.0</td>
      </tr>
      <tr>
          <td>12</td>
          <td>Capacitor 10¬µF</td>
          <td>2.0</td>
      </tr>
      <tr>
          <td>13</td>
          <td>Capacitor 1nF</td>
          <td>1.0</td>
      </tr>
      <tr>
          <td>14</td>
          <td>Capacitor 10nF</td>
          <td>1.0</td>
      </tr>
      <tr>
          <td>15</td>
          <td>Capacitor 100nF</td>
          <td>2.0</td>
      </tr>
      <tr>
          <td>16</td>
          <td>Resistor 330‚Ñ¶</td>
          <td>2.0</td>
      </tr>
      <tr>
          <td>17</td>
          <td>Resistor 1K‚Ñ¶</td>
          <td>7.0</td>
      </tr>
      <tr>
          <td>18</td>
          <td>Resistor 4.7K‚Ñ¶</td>
          <td>1.0</td>
      </tr>
      <tr>
          <td>19</td>
          <td>Resistor 100K‚Ñ¶</td>
          <td>4.0</td>
      </tr>
      <tr>
          <td>20</td>
          <td>Resistor 330K‚Ñ¶</td>
          <td>2.0</td>
      </tr>
  </tbody>
</table>
<figure>
    <img loading="lazy" src="robot_block_diagram.jpg"
         alt="Robot block diagram"/> 
</figure>

<h4 id="remote-controller">Remote controller<a hidden class="anchor" aria-hidden="true" href="#remote-controller">#</a></h4>
<figure>
    <img loading="lazy" src="left_view.jpg"
         alt="Remote"/> 
</figure>

<table>
  <thead>
      <tr>
          <th>No.</th>
          <th>Components</th>
          <th>Quantity</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>1</td>
          <td>ATMega328P</td>
          <td>1</td>
      </tr>
      <tr>
          <td>2</td>
          <td>CEM-1203(42)</td>
          <td>1</td>
      </tr>
      <tr>
          <td>3</td>
          <td>FT230XSR</td>
          <td>1</td>
      </tr>
      <tr>
          <td>4</td>
          <td>FQU13N06LTU</td>
          <td>1</td>
      </tr>
      <tr>
          <td>5</td>
          <td>JDY-40</td>
          <td>1</td>
      </tr>
      <tr>
          <td>6</td>
          <td>MCP1700</td>
          <td>6</td>
      </tr>
      <tr>
          <td>7</td>
          <td>1N4148</td>
          <td>1</td>
      </tr>
      <tr>
          <td>8</td>
          <td>QYF-860</td>
          <td>1</td>
      </tr>
      <tr>
          <td>9</td>
          <td>Resistor 2K‚Ñ¶</td>
          <td>1</td>
      </tr>
      <tr>
          <td>10</td>
          <td>Resistor 1K‚Ñ¶</td>
          <td>1</td>
      </tr>
      <tr>
          <td>11</td>
          <td>Push buttons</td>
          <td>2</td>
      </tr>
      <tr>
          <td>12</td>
          <td>Capacitor 0.1¬µF</td>
          <td>1</td>
      </tr>
      <tr>
          <td>13</td>
          <td>Capacitor 100¬µF</td>
          <td>1</td>
      </tr>
  </tbody>
</table>
<p>The robot system was composed of multiple functional components: the robot chassis motor drive, microcontroller, metal and perimeter detectors, wireless radio communication and coin-picking mechanism. Each subsystem was designed by applying principles of embedded systems, A/D design circuit design and power management.</p>
<p><strong>Power regulation:</strong></p>
<ul>
<li>
<p>Design approach: The robot uses 4x AA batteries (6V) to power the motors and optocouplers, and a 9V battery regulated to 5V by an LM7805 and an MCP1700 for 3.3V.</p>
</li>
<li>
<p>LM7805: provides 5V for the EFM8 and sensors.</p>
</li>
<li>
<p>MCP1700: provides 3.3V for JDY-40 and microcontroller</p>
</li>
<li>
<p>Microcontroller system:</p>
</li>
</ul>
<ol>
<li>Robot MCU ‚Äì EFM8:</li>
</ol>
<ul>
<li>4 PWM digital outputs for motor control, UART + SET pins for JDY-40 communication, 1 digital input for metal detector, and 4 analog inputs for perimeter detectors</li>
</ul>
<ol start="2">
<li>Remote MCU ‚Äì ATMEGA328:</li>
</ol>
<ul>
<li>6 digital outputs for LCD, 2 analog inputs for joystick, 1 digital output for speaker, 3 UART pins for JDY-40</li>
<li>Motor driver: H-bridge and optocouplers</li>
<li>2 discrete H-bridges, each consists of N-MOS and P-MOS transistors driven by optocouplers (LTV-847), control 2 DC motors by isolation motor power circuitry from the logic-level control.</li>
</ul>
<ol start="3">
<li>Metal detector:</li>
</ol>
<ul>
<li>A Colpitts Oscillator with discrete CMOS inverter built from discrete components.</li>
<li>Powered at 5V</li>
<li>The frequency shift when metal is in the vicinity is detected by the MCU</li>
</ul>
<ol start="4">
<li>Perimeter detectors:</li>
</ol>
<ul>
<li>A peak detector circuit, whose signal is amplified using an Op-Amp.</li>
<li>Two were put perpendicular to each other at the front of the robot chassis for all-direction sensitivity</li>
<li>Output is fed to analog pins of the EFM8 for perimeter detection logic</li>
</ul>
<ol start="5">
<li>Radio communication: JDY-40 radio pair</li>
</ol>
<ul>
<li>Uses RXD, TXD and SET pins for serial communication between robot and remote.</li>
<li>Powered by 3.3 V and communicates at 9600 baud</li>
</ul>
<ol start="6">
<li>Joystick, speaker and LCD (remote):</li>
</ol>
<ul>
<li>Joystick: 2-axis analog potentiometer-type joystick connected to 2 analog inputs</li>
<li>LCD: standard 14-bit display driven by MCU digital outputs</li>
<li>Speaker: generates PWM audio cues via a single digital output</li>
</ul>
<ol start="7">
<li>Coin-picking mechanism:</li>
</ol>
<ul>
<li>Utilizes an electromagnet, servo motors and chassis-integrated basket to pick up metal coins.</li>
</ul>
<figure>
    <img loading="lazy" src="remote_block_diagram.jpg"
         alt="Robot block diagram"/> 
</figure>

<h2 id="standard-operating-procedure">Standard Operating Procedure<a hidden class="anchor" aria-hidden="true" href="#standard-operating-procedure">#</a></h2>
<p>Our team began with a structured engineering approach to ensure each subsystem was reliably tested and validated before moving on to subsequent phases of the project. First, we focused on the hardware: we assembled the robot chassis (wheels, motors, coin picking assembly, electromagnet, inductor coils for metal and perimeter detector and basket), and tested the key components‚Äîsuch as the Colpitts oscillator and simple perimeter detector circuits, both microcontrollers (ATMEGA328 and EFM8), JDY-40 radios‚Äîto confirm they functioned correctly. By establishing a stable hardware baseline, we minimized the risk of falsely attributing errors during software development to hardware issues.</p>
<h2 id="requirements-and-constraints">Requirements and Constraints<a hidden class="anchor" aria-hidden="true" href="#requirements-and-constraints">#</a></h2>
<p>We gathered requirements by discussing baseline robot operations based on the outlined requirements, carefully examining the lecture slides and reviewing relevant best practices for designing and operating a multi-pronged system such as this project. From these activities, we identified the following needs and constraints:</p>
<ul>
<li>Streamlined controls during manual mode: the remote (both in terms of hardware and software) must be designed to allow for intuitive and ease of control during manual operations. Steps must be made to always allow for smooth and accurate controls with little interruptions, glitches or delay.</li>
<li>Optimized robot logic during automatic operation: the robot must be able to perform multiple tasks simultaneously at any given point. This emphasizes the need for a clear logic flow that will allow for optimal performance and ease of debugging.</li>
<li>Succinct integration between automatic and manual mode: The operator must be able to switch between automatic and manual mode at any given time. Once in automatic mode, the robot must strictly adhere to the base requirements of this project (i.e. stays withing the perimeter, automatically detects and picks up coin). In addition, after the 20 coins have been picked up during the automatic process, the robot should halt and awaits further instructions from the operator.</li>
<li>Relevant Information Display: The remote should (at the bare minimum) display the signal strength based on which type of coins are detected. The signal strength must also be represented by an audio cue via a speaker.
By systematically identifying and documenting these needs, we ensured our design choices directly addressed user requirements and practical constraints from the outset, helping guide all subsequent design and development efforts.</li>
</ul>
<h2 id="solution-generation">Solution Generation<a hidden class="anchor" aria-hidden="true" href="#solution-generation">#</a></h2>
<p>Our team generated solution systematically and took into consideration various methods to address the project‚Äôs core requirements. We started by investigating different hardware and software configurations to deal with the robot‚Äôs various operational requirements.</p>
<ol>
<li><strong>Controls:</strong></li>
</ol>
<ul>
<li>We opted for a simple, 2-axis control via the provided joystick when it comes to the movement of the robot.</li>
<li>The robot arm can be activated by pressing down on the joystick</li>
<li>Toggling between manual and automatic mode can be done via a pushbutton.</li>
</ul>
<ol start="2">
<li><strong>Radio communication between robot and remote:</strong></li>
</ol>
<ul>
<li>The ATMEGA328 microcontroller had several built-in ADC input pins, which, when connected to the joystick, can translate its movement into ADC signal and then to voltage. We then programmed the movement of the robot by figuring out the joystick‚Äôs ‚Äúdead zone‚Äù and finetuning it to fit with the H-bridge logic, which is then used to move the robot.</li>
</ul>
<ol start="3">
<li><strong>Software Implementation:</strong></li>
</ol>
<ul>
<li>Our team decided to drive the robot‚Äôs logic by imbedding different parameters as presets. From the frequency picked up by the perimeter and metal detector, to the text command signals sent and received from the robot to the remote, we were able to systematically work out the robot‚Äôs core operation via simple while loops and if-else statements. This greatly enhanced the efficiency of our workflow, allowed for ease of debugging and optimized the robot‚Äôs performance and accuracy.</li>
</ul>
<h2 id="solution-evaluation">Solution Evaluation<a hidden class="anchor" aria-hidden="true" href="#solution-evaluation">#</a></h2>
<p>After potential solutions were generated, we evaluated each of them based on accuracy, ease of implementation and how well each idea interacts with one and another in the context of this project. Our evaluation criteria included:</p>
<ul>
<li><strong>Hardware reliability</strong>: assuring an ergonomic, neat and efficient circuit design that minimizes errors and allows for easier modification and troubleshooting, as well as succinct integration with software.</li>
<li><strong>Software efficiency</strong>: ensuring an optimal and logical code flow that once again highlights the need for ease of troubleshooting and modification.</li>
<li>Efficient and predictable robot operation.</li>
</ul>
<h2 id="key-findings">Key Findings:<a hidden class="anchor" aria-hidden="true" href="#key-findings">#</a></h2>
<p>Although a simple control scheme and clear logic-based code fast-tracked the development of our design, we encountered multiple hiccups regarding to the communication between the robot and remote, which caused unpredictable robot movements, delays and crashes. We eventually narrowed down the cause of the issue: the radio communication received by the robot from the remote were somehow being offset. To be more specific:</p>
<ul>
<li>For example, during manual operation, when the robot is commanded to move forward, the operator moves the joystick forward, which will send a series of signal to the robot, the continuous signal looks something like this: ‚Äú!FN!FN!‚Ä¶.‚Äù The software of the robot was supposed to only grab ‚ÄúFN‚Äù, which was the valid command for ‚Äúforward neutral‚Äù, but sometimes, it picked up ‚Äú!F‚Äù, which was a false command based on our existing logic. This happened consistently for other commands as well, causing the robot to behave unpredictably. We were able to fix this issue by hardcoding the invalid commands (i.e. ‚Äú!F‚Äù, etc.) as valid instructions. This fixed the issue, while maintaining the overall code efficiency and logic flow:</li>
</ul>
<figure>
    <img loading="lazy" src="codefixing.jpg"
         alt="Expanding parameter for bug fixing"/> 
</figure>

<h2 id="software">Software<a hidden class="anchor" aria-hidden="true" href="#software">#</a></h2>
<ol>
<li><strong>Slave code:</strong></li>
</ol>
<ul>
<li>Servos control: Implemented in Timer5_ISR, creating PWM signals with a 20ms period</li>
<li>Sensor integration:</li>
<li>Metal detector: coins are detected via frequency shift</li>
<li>Perimeter detectors: voltage threshold logic triggers a perimeter flag</li>
<li>Movement control:</li>
<li>Motor logic implemented via move_robot() function; encoded movement commands include:
<ul>
<li>‚ÄúFN‚Äù: Forward (2-wheels moving forward), ‚ÄúBN‚Äù: Backwards (2-wheels moving backward), ‚ÄúHL‚Äù / ‚ÄúHR‚Äù: Hard-left, Hard-right (1-wheel moving forward, other backward), ‚ÄúFL‚Äù / ‚ÄúFR‚Äù: Gradual-left, Gradual-right (Only one wheel moving forward), BL‚Äù / ‚ÄúBR‚Äù: Back-left, Back-right (Only one wheel moving backward) and ‚ÄúST‚Äù: Stop</li>
</ul>
</li>
<li>Coin-picking mechanism:</li>
<li>Servos_magnet() executes a defined range of motion sequence to pick up coins upon detection</li>
<li>Wireless communication:
<ul>
<li>Slave-to-master transmits coin data types (‚Äú!DO‚Äù - Dollar, ‚Äú!TW‚Äù ‚Äì 2 Dollars, ‚Äú!NI‚Äù ‚Äì Nickel, etc.)</li>
<li>‚ÄúTO‚Äù ‚Äì toggles between manual and automatic modes</li>
<li>‚ÄúPU‚Äù  - triggers the coin pick-up sequence</li>
<li>Unknown commands are handled (see Key findings, above)</li>
</ul>
</li>
<li>Automatic mode logic:
<ul>
<li>Moves forward by default</li>
<li>If perimeter is detected, triggers perimeter_flag, then executes a range of motion moving backward then turning right (the degree of turn is randomized)</li>
<li>If metal is detected, uses frequency difference baseline to:</li>
</ul>
</li>
<li>Detect presence of coin (triggers coinflag); Classify coin types (coin_tier); Broadcast coin classification to master (remote); Activate servos_magnet() to collect coin</li>
<li>Coin collection is hardcoded to 20. After 20 pick-ups, the robot stops. Note that the robot has no means to detect a successful pick-up. It counts every activation of the coin-picking assembly as an attempt.</li>
<li>Manual mode logic:</li>
<li>In manual mode, commands are received wirelessly and processed directly</li>
<li>‚ÄúPU‚Äù initiates the pick-up sequence</li>
<li>Directional and stop commands are passed to move_robot()</li>
</ul>
<ol start="2">
<li><strong>Master Code:</strong></li>
</ol>
<ul>
<li>Core features:
<ul>
<li>Joystick-based control: reads analog joystick input to send movement commands.</li>
<li>Mode toggle: a pushbutton to toggle between automatic and manual mode by sending ‚Äú!TO‚Äù and waits for ‚Äú!TD‚Äù / ‚Äú!TF confirmation</li>
<li>Pressing down on the joystick to send ‚Äú!PU‚Äù to activate the coin collection sequence</li>
</ul>
</li>
<li>JDY-40 communication:
<ul>
<li>Sends commands with a ‚Äú!‚Äù header (e.g., ‚Äú!FN‚Äù, ‚Äú!ST‚Äù, ‚Äú!PU‚Äù, etc.)</li>
<li>Receives coin types identifiers from the robot (‚ÄúDI‚Äù, ‚ÄúQU‚Äù, ‚ÄúNI‚Äù, ‚ÄúTW‚Äù, ‚ÄúDO‚Äù) and toggles ‚ÄúTF‚Äù from the robot</li>
</ul>
</li>
<li>Speaker feedback:
<ul>
<li>Uses Timer0 interrupts to generates tones with different frequencies based on coin type:</li>
</ul>
</li>
<li>LCD feedback:
<ul>
<li>Two-line LCD display:
<ul>
<li>Current mode (‚ÄúToggle On/Off‚Äù) and coin strength</li>
<li>Display and updates joystick command (e.g. Forward, etc.)</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="solution-assessment">Solution assessment<a hidden class="anchor" aria-hidden="true" href="#solution-assessment">#</a></h1>
<ul>
<li>The robot was tested over 20 independent trials across various coin placement within the perimeter</li>
<li>Consistency of successful number of coins pick up per run remained at 18-19 out of 20 coins (¬± 1)</li>
<li>List of performed tests and observations:</li>
</ul>
<table>
  <thead>
      <tr>
          <th>Test</th>
          <th>Expected Outcome</th>
          <th>Observed Outcome</th>
          <th>Pass/Fail</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Coin detection (static and moving)</td>
          <td>Coin correctly identified and picked up</td>
          <td>Coin detection is 100% functional, but hardcoded movement after pickup only allowed for 80‚Äì90% success</td>
          <td>Pass (Partial)</td>
      </tr>
      <tr>
          <td>Boundary detection</td>
          <td>Robot reroutes away from the perimeter</td>
          <td>Correct response 100% of the time</td>
          <td>Pass</td>
      </tr>
      <tr>
          <td>Remote toggle and command response</td>
          <td>Mode toggles + joystick driving</td>
          <td>Works reliably with LCD feedback; minor inconsistency with auto/manual toggle</td>
          <td>Pass (Partial)</td>
      </tr>
      <tr>
          <td>Coin classification</td>
          <td>Correct sound + LCD</td>
          <td>All coin types correctly identified</td>
          <td>Pass</td>
      </tr>
  </tbody>
</table>
<h1 id="conclusion-and-reflection">Conclusion and Reflection<a hidden class="anchor" aria-hidden="true" href="#conclusion-and-reflection">#</a></h1>
<p>This project was a great learning experience in hardware design, firmware development, and time management. Using two family of microcontrollers required a lot of planning, testing and attention to details as well as a lot of debugging. I learned the use of makefiles, code initialization and the importance of coding sparingly and efficiently. I also learned the importance of clear hardware design and wiring as it made the debugging process much easier. I also learned the importance of testing and validating each subsystem before moving on to the next phase of the project. This helped us to identify and fix issues early on, rather than waiting until the end of the project to find out that something was not working.</p>
<p>I was also really proud of the team perserverance and dedication to the project. Despite having both technical difficulties when integrating the radio communication and some communication issues within the team especially at the end when we also had final exams, we were able to come together, push through till the final hours of the project and delivered an product that was worthy of pads on the back.</p>
<h1 id="acknowledgements">Acknowledgements<a hidden class="anchor" aria-hidden="true" href="#acknowledgements">#</a></h1>
<p>I want to thank my team members, Jackson Rockford, Matthew Yeun, Harry Nguyen and Adrian Chua for their hard work and dedication to the project. I also want to thank the ELEC 291 instructor, Jesus Calvino-Fraga for his guidance and support throughout the project.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://ap010307.github.io/portfolio/tags/altium/">Altium</a></li>
      <li><a href="https://ap010307.github.io/portfolio/tags/assembly/">Assembly</a></li>
      <li><a href="https://ap010307.github.io/portfolio/tags/circuit-design/">Circuit Design</a></li>
      <li><a href="https://ap010307.github.io/portfolio/tags/python/">Python</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="https://ap010307.github.io/portfolio/projects/reflow_oven/">
    <span class="title">Next ¬ª</span>
    <br>
    <span>Reflow Oven Controller</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Coin picking robot on x"
            href="https://x.com/intent/tweet/?text=Coin%20picking%20robot&amp;url=https%3a%2f%2fap010307.github.io%2fportfolio%2fprojects%2frobot_picking_up%2f&amp;hashtags=Altium%2cAssembly%2cCircuitDesign%2cPython">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Coin picking robot on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fap010307.github.io%2fportfolio%2fprojects%2frobot_picking_up%2f&amp;title=Coin%20picking%20robot&amp;summary=Coin%20picking%20robot&amp;source=https%3a%2f%2fap010307.github.io%2fportfolio%2fprojects%2frobot_picking_up%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Coin picking robot on reddit"
            href="https://reddit.com/submit?url=https%3a%2f%2fap010307.github.io%2fportfolio%2fprojects%2frobot_picking_up%2f&title=Coin%20picking%20robot">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Coin picking robot on facebook"
            href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fap010307.github.io%2fportfolio%2fprojects%2frobot_picking_up%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Coin picking robot on whatsapp"
            href="https://api.whatsapp.com/send?text=Coin%20picking%20robot%20-%20https%3a%2f%2fap010307.github.io%2fportfolio%2fprojects%2frobot_picking_up%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Coin picking robot on telegram"
            href="https://telegram.me/share/url?text=Coin%20picking%20robot&amp;url=https%3a%2f%2fap010307.github.io%2fportfolio%2fprojects%2frobot_picking_up%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Coin picking robot on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=Coin%20picking%20robot&u=https%3a%2f%2fap010307.github.io%2fportfolio%2fprojects%2frobot_picking_up%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://ap010307.github.io/portfolio/">Allen Pham</a></span> ¬∑ 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
